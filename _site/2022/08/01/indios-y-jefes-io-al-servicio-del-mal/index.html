<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="jlcr">
<meta name="dcterms.date" content="2022-08-01">

<title>Muestrear no es pecado - Indios y jefes, IO al servicio del mal.</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">Muestrear no es pecado</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../blog.html">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/joscani"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/joscani"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://fosstodon.org/@joscani"><i class="bi bi-mastodon" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../../blog.xml"><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-resources" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Resources</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-resources">    
        <li>
    <a class="dropdown-item" href="https://rweekly.org/">
 <span class="dropdown-text">R Weekly</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://www.r-bloggers.com/">
 <span class="dropdown-text">R Bloggers</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://www.datanalytics.com/">
 <span class="dropdown-text">Datanalytics</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../../archive.html">
 <span class="menu-text">Archivo</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introducción" id="toc-introducción" class="nav-link active" data-scroll-target="#introducción">Introducción</a></li>
  <li><a href="#carga-de-datos-y-crear-datos-ficticios." id="toc-carga-de-datos-y-crear-datos-ficticios." class="nav-link" data-scroll-target="#carga-de-datos-y-crear-datos-ficticios.">Carga de datos y crear datos ficticios.</a>
  <ul class="collapse">
  <li><a href="#carga-códigos-postales" id="toc-carga-códigos-postales" class="nav-link" data-scroll-target="#carga-códigos-postales">Carga códigos postales</a></li>
  <li><a href="#datos-ficticios-de-las-sedes-de-las-empresas" id="toc-datos-ficticios-de-las-sedes-de-las-empresas" class="nav-link" data-scroll-target="#datos-ficticios-de-las-sedes-de-las-empresas">Datos ficticios de las sedes de las empresas</a></li>
  </ul></li>
  <li><a href="#io-al-servicio-del-mal-en-granada" id="toc-io-al-servicio-del-mal-en-granada" class="nav-link" data-scroll-target="#io-al-servicio-del-mal-en-granada">IO al servicio del mal en GRANADA</a></li>
  <li><a href="#optimización" id="toc-optimización" class="nav-link" data-scroll-target="#optimización">Optimización</a></li>
  <li><a href="#io-al-servicio-del-mal-eligiendo-provincia" id="toc-io-al-servicio-del-mal-eligiendo-provincia" class="nav-link" data-scroll-target="#io-al-servicio-del-mal-eligiendo-provincia">IO al servicio del mal eligiendo provincia</a>
  <ul class="collapse">
  <li><a href="#madrid" id="toc-madrid" class="nav-link" data-scroll-target="#madrid">MADRID</a></li>
  <li><a href="#barcelona" id="toc-barcelona" class="nav-link" data-scroll-target="#barcelona">Barcelona</a></li>
  <li><a href="#sevilla" id="toc-sevilla" class="nav-link" data-scroll-target="#sevilla">Sevilla</a></li>
  <li><a href="#granada-y-málaga-juntas" id="toc-granada-y-málaga-juntas" class="nav-link" data-scroll-target="#granada-y-málaga-juntas">Granada y Málaga juntas</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Indios y jefes, IO al servicio del mal.</h1>
  <div class="quarto-categories">
    <div class="quarto-category">estadística</div>
    <div class="quarto-category">Investigación operativa</div>
    <div class="quarto-category">R</div>
    <div class="quarto-category">2022</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>jlcr </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 1, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introducción" class="level2">
<h2 class="anchored" data-anchor-id="introducción">Introducción</h2>
<p>Voy a poner un ejemplo de como utilizar solvers para investigación operativa dentro de R.</p>
<p>Tenemos la siguiente información: * Listado de códigos postales de España con la longitud y latitud del centroide del polígono. * Listado de códigos postales de la ubicación de las sedes de una empresa. * En la empresa hay jefes e indios, no es necesario que haya un jefe por sede.</p>
<p>Se quiere, para cada provincia de España</p>
<ul>
<li>Asignar cada código postal de esa provincia a un empleado de la empres (jefe o indio).</li>
<li>Un mismo código postal no puede estar asignado a más de un empleado.</li>
<li>En la medida de lo posible asignar a los empleados los códigos postales más cercanos al lugar de su sede.</li>
<li>A igualdad de distancia entre un código postal y una sede, se debería asignar ese código postal a un indio.</li>
<li>Ningún indio debe tener asignados menos códigos postales que ningún jefe.</li>
<li>Los jefes como <strong>máximo</strong> han de tener 7 códigos postales asignados.</li>
<li>Los indios como <strong>mínimo</strong> han de tener 3 códigos postales asignados.</li>
<li>No puede haber ningún empleado que esté “desasignado”.</li>
</ul>
<p>Dados estos requisitos debería plantear como es la definición del problema, pero no tengo ganas de ponerme a escribir fórmulas en latex, así que en vez de eso voy a utilizar unos datos simulados y directamente al código..</p>
</section>
<section id="carga-de-datos-y-crear-datos-ficticios." class="level2">
<h2 class="anchored" data-anchor-id="carga-de-datos-y-crear-datos-ficticios.">Carga de datos y crear datos ficticios.</h2>
<section id="carga-códigos-postales" class="level3">
<h3 class="anchored" data-anchor-id="carga-códigos-postales">Carga códigos postales</h3>
<p>Casualmente, tengo por mi pc un shapefile algo antiguo (de cuando está capa estaba en cartociudad) con la capa de códigos postales de España, la cual si se quiere actualizada vale un dinerillo. <a href="https://www.market.correos.es/es/product/capa-cartografica-de-codigos-postales">correos</a>, 6000 Euros la versión sin actualizaciones.. Bueno, si hacienda y correos somos todos me gustaría al menos poder utilizar esto actualizado sin que me cueste 6k.</p>
<p>Vamos a cargar la capa, obtener los centroides, pasar la geometría a longitud y latitud</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──
## ✔ ggplot2 3.3.6     ✔ purrr   0.3.4
## ✔ tibble  3.1.8     ✔ dplyr   1.0.9
## ✔ tidyr   1.2.0     ✔ stringr 1.4.0
## ✔ readr   2.1.2     ✔ forcats 0.5.1
## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## Linking to GEOS 3.8.0, GDAL 3.0.4, PROJ 6.3.1; sf_use_s2() is TRUE</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>cod_postales_raw <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/cp_boundaries.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>cp_num, <span class="sc">-</span>cp_2_num)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cod_postales_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## Simple feature collection with 6 features and 3 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -1536953 ymin: 3373964 xmax: -41802.13 ymax: 5247186
## Projected CRS: WGS 84 / Pseudo-Mercator
##      cp cp_2   area_m2                       geometry
## 1 35560   35 187875455 MULTIPOLYGON (((-1518970 33...
## 2 27330   27   6659413 MULTIPOLYGON (((-821864.3 5...
## 3 46680   46  69190773 MULTIPOLYGON (((-51610.46 4...
## 4 49706   49  90229134 MULTIPOLYGON (((-641488.4 5...
## 5 21120   21  20068648 MULTIPOLYGON (((-776955.2 4...
## 6 16623   16 132859998 MULTIPOLYGON (((-256256.7 4...</code></pre>
<p>Pintamos algunos códigos</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(cod_postales_raw[<span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>, ]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="unnamed-chunk-3-1.png" width="672"></p>
<p>Para obtener los centroides, usamos la función <code>st_centroid</code> y pasamos la capa de polígonos a una de puntos</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>cod_postales_raw <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(cod_postales_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## Warning in st_centroid.sf(cod_postales_raw): st_centroid assumes attributes are
## constant over geometries of x</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cod_postales_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## Simple feature collection with 6 features and 3 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: -1525406 ymin: 3382025 xmax: -47782.92 ymax: 5245455
## Projected CRS: WGS 84 / Pseudo-Mercator
##      cp cp_2   area_m2                  geometry
## 1 35560   35 187875455  POINT (-1525406 3382025)
## 2 27330   27   6659413 POINT (-823274.9 5245455)
## 3 46680   46  69190773 POINT (-47782.92 4752325)
## 4 49706   49  90229134 POINT (-637415.5 5057096)
## 5 21120   21  20068648 POINT (-778872.1 4479315)
## 6 16623   16 132859998 POINT (-262034.3 4818194)</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(cod_postales_raw[<span class="dv">1</span><span class="sc">:</span><span class="dv">2000</span>, ]), <span class="at">cex =</span> <span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="unnamed-chunk-4-1.png" width="672"></p>
<p>Ahora extraemos de la geometría la longitud y latitud. Para eso hay que transformar la geometría.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>cod_postales_raw <span class="ot">&lt;-</span> cod_postales_raw <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="st">"+proj=longlat +ellps=WGS84 +datum=WGS84"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>cod_postales <span class="ot">&lt;-</span> cod_postales_raw <span class="sc">%&gt;%</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">centroide_longitud =</span> <span class="fu">unlist</span>(<span class="fu">map</span>(geometry, <span class="dv">1</span>)),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">centroide_latitud =</span> <span class="fu">unlist</span>(<span class="fu">map</span>(geometry, <span class="dv">2</span>))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> <span class="co"># quitamos la geometría y nos quedamos solo con la longitud y latitud</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">cod_postal =</span> cp,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">cod_prov =</span> cp_2</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(centroide_longitud)) <span class="co"># tenía un polígono con NAS</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cod_postales)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>##   cod_postal cod_prov   area_m2 centroide_longitud centroide_latitud
## 1      35560       35 187875455        -13.7029565          29.05011
## 2      27330       27   6659413         -7.3956047          42.56144
## 3      46680       46  69190773         -0.4292412          39.21368
## 4      49706       49  90229134         -5.7260007          41.30272
## 5      21120       21  20068648         -6.9967272          37.28791
## 6      16623       16 132859998         -2.3538946          39.67063</code></pre>
<p>Por otro lado me interesa añadir el literal de provincia, tengo una tabla extraída del INE con la correspondencia entre cod_prov y el literal</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>provincia <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/codprov.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## Rows: 52 Columns: 2
## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: ","
## chr (2): CODIGO, LITERAL
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(provincia)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## # A tibble: 6 × 2
##   CODIGO LITERAL         
##   &lt;chr&gt;  &lt;chr&gt;           
## 1 02     Albacete        
## 2 03     Alicante/Alacant
## 3 04     Almería         
## 4 01     Araba/Álava     
## 5 33     Asturias        
## 6 05     Ávila</code></pre>
<p>Normalizo a mayúsculas y sin tildes y se lo pego a los códigos postales</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>provincia <span class="ot">&lt;-</span> provincia <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">provincia =</span> <span class="fu">toupper</span>(stringi<span class="sc">::</span><span class="fu">stri_trans_general</span>(LITERAL, <span class="st">"Latin-ASCII"</span>)))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>cod_postales <span class="ot">&lt;-</span> cod_postales <span class="sc">%&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(provincia <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>      CODIGO,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>      provincia</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"cod_prov"</span> <span class="ot">=</span> <span class="st">"CODIGO"</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(cod_postales)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## [1] 10808     6</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cod_postales <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(provincia, cod_prov, <span class="fu">everything</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>##           provincia cod_prov cod_postal   area_m2 centroide_longitud
## 1       PALMAS, LAS       35      35560 187875455        -13.7029565
## 2              LUGO       27      27330   6659413         -7.3956047
## 3 VALENCIA/VALENCIA       46      46680  69190773         -0.4292412
## 4            ZAMORA       49      49706  90229134         -5.7260007
## 5            HUELVA       21      21120  20068648         -6.9967272
## 6            CUENCA       16      16623 132859998         -2.3538946
##   centroide_latitud
## 1          29.05011
## 2          42.56144
## 3          39.21368
## 4          41.30272
## 5          37.28791
## 6          39.67063</code></pre>
</section>
<section id="datos-ficticios-de-las-sedes-de-las-empresas" class="level3">
<h3 class="anchored" data-anchor-id="datos-ficticios-de-las-sedes-de-las-empresas">Datos ficticios de las sedes de las empresas</h3>
<p>Lo que voy a hacer es seleccionar aleatoriamente un número de códigos postales en cada provincia, que serán las sedes de la empresa. En cada provincia pongo al menos a un empleado de tipo = “jefe”. Luego, reparto de forma aleatoria entre los códigos postales que han sido elegidos como sedes otros 120 jefes y 480 indios.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">155</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="do">## En cada provincia nos quedamos con  un 6% de códigos postales</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>sedes_alea <span class="ot">&lt;-</span> cod_postales <span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(provincia) <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">prop =</span> <span class="fl">0.06</span>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># en cada provincia al menos un jefe y resto de empleados de forma aleatoria, en las diferentes sedes elegidas</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>personal <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  sedes_alea <span class="sc">%&gt;%</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(provincia, cod_postal) <span class="sc">%&gt;%</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(provincia) <span class="sc">%&gt;%</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(cod_postal) <span class="sc">%&gt;%</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">tipo =</span> <span class="st">"jefe"</span>),</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">tipo =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"jefe"</span>, <span class="dv">120</span>), <span class="fu">rep</span>(<span class="st">"indio"</span>, <span class="dv">360</span>)),</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">cod_postal =</span> <span class="fu">sample</span>(sedes_alea<span class="sc">$</span>cod_postal, <span class="at">size =</span> <span class="dv">480</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Creamos data set sedes</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>sedes <span class="ot">&lt;-</span> personal <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(sedes_alea)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## Joining, by = "cod_postal"</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(sedes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## [1] 530   7</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sample_n</span>(sedes, <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## # A tibble: 7 × 7
##   cod_postal tipo  cod_prov    area_m2 centroide_longitud centroide_la…¹ provi…²
##   &lt;fct&gt;      &lt;chr&gt; &lt;chr&gt;         &lt;dbl&gt;              &lt;dbl&gt;          &lt;dbl&gt; &lt;chr&gt;  
## 1 37660      indio 37        36448279.              -5.99           40.5 SALAMA…
## 2 41770      jefe  41       183345907.              -5.55           37.0 SEVILLA
## 3 08011      jefe  08          968836.               2.16           41.4 BARCEL…
## 4 34479      indio 34        49891663.              -4.42           42.4 PALENC…
## 5 34859      indio 34       118812672.              -4.59           42.8 PALENC…
## 6 09348      indio 09       249695400.              -3.61           42.0 BURGOS 
## 7 29750      indio 29        14389642.              -4.04           36.8 MALAGA 
## # … with abbreviated variable names ¹​centroide_latitud, ²​provincia</code></pre>
</section>
</section>
<section id="io-al-servicio-del-mal-en-granada" class="level2">
<h2 class="anchored" data-anchor-id="io-al-servicio-del-mal-en-granada">IO al servicio del mal en GRANADA</h2>
<p>Como ejemplo, vamos a ver como sería para Granada</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>cod_postales_granada <span class="ot">&lt;-</span> cod_postales <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(provincia <span class="sc">==</span> <span class="st">"GRANADA"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>())</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>sedes_granada <span class="ot">&lt;-</span> sedes <span class="sc">%&gt;%</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(provincia <span class="sc">==</span> <span class="st">"GRANADA"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(tipo)) <span class="sc">%&gt;%</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id_sede =</span> <span class="fu">row_number</span>())</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>sedes_granada</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## # A tibble: 11 × 8
##    cod_postal tipo  cod_prov    area_m2 centroide_long…¹ centr…² provi…³ id_sede
##    &lt;fct&gt;      &lt;chr&gt; &lt;chr&gt;         &lt;dbl&gt;            &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;     &lt;int&gt;
##  1 18328      jefe  18        58574459.            -3.87    37.2 GRANADA       1
##  2 18006      jefe  18         3245912.            -3.61    37.2 GRANADA       2
##  3 18516      jefe  18       146541813.            -3.24    37.2 GRANADA       3
##  4 18516      jefe  18       146541813.            -3.24    37.2 GRANADA       4
##  5 18197      indio 18        10003524.            -3.61    37.2 GRANADA       5
##  6 18516      indio 18       146541813.            -3.24    37.2 GRANADA       6
##  7 18414      indio 18        40411565.            -3.34    36.9 GRANADA       7
##  8 18197      indio 18        10003524.            -3.61    37.2 GRANADA       8
##  9 18369      indio 18        17670871.            -4.01    37.2 GRANADA       9
## 10 18611      indio 18        33542783.            -3.60    36.8 GRANADA      10
## 11 18514      indio 18       110524485.            -3.08    37.2 GRANADA      11
## # … with abbreviated variable names ¹​centroide_longitud, ²​centroide_latitud,
## #   ³​provincia</code></pre>
<p>Es importante haber ordenado por tipo , porque vamos a utilizar el mismo índice <code>j</code> para empleados jefe y empleados indios.</p>
<p>Ahora definimos: * <code>m</code> como el número de empleados en las sedes de Granada * <code>n</code> como el número de códigos postales a asignar en Granada * <code>n_sedes</code> como el número de sedes * <code>njefes</code> como el número de jefes * <code>n_indios</code> como el número de indios</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">nrow</span>(sedes_granada)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(cod_postales_granada)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>n_sedes <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(sedes_granada<span class="sc">$</span>cod_postal))</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>njefes <span class="ot">&lt;-</span> sedes_granada <span class="sc">%&gt;%</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(tipo <span class="sc">==</span> <span class="st">"jefe"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>n_indios <span class="ot">&lt;-</span> m <span class="sc">-</span> njefes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Necesitamos definir una función de distancia entre los códigos postales a asignar y las sedes. Para eso usamos la distancia Haversine que está implementada en la librería <code>geosphere</code>. Y aquí ya introducimos uno de los requerimientos. Básicamente aumentamos la distancia un 10% si el empleado es un jefe, de forma que sea peor asignarle ese código postal al jefe en términos de minimizar el total de distancias.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>transportcost_granada <span class="ot">&lt;-</span> <span class="cf">function</span>(i, j) {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  cliente <span class="ot">&lt;-</span> cod_postales_granada[i, ]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  comercial <span class="ot">&lt;-</span> sedes_granada[j, ]</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  distancia <span class="ot">&lt;-</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    geosphere<span class="sc">::</span><span class="fu">distHaversine</span>(</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(cliente<span class="sc">$</span>centroide_longitud, cliente<span class="sc">$</span>centroide_latitud),</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(comercial<span class="sc">$</span>centroide_longitud, comercial<span class="sc">$</span>centroide_latitud)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (comercial[, <span class="st">"tipo"</span>] <span class="sc">==</span> <span class="st">"jefe"</span>) {</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    distancia <span class="ot">&lt;-</span> distancia <span class="sc">*</span> <span class="fl">1.1</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(distancia <span class="sc">/</span> <span class="dv">1000</span>) <span class="co"># devolvemos la disancia en km</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="co"># distancia entre sede 1 y empleado 3</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="fu">transportcost_granada</span>(<span class="dv">1</span>, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## [1] 51.54738</code></pre>
<p>Pintamos los códigos postales y las sedes. Los granadinos reconoceremos la forma de la provincia.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    cod_postales_granada,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(centroide_longitud, centroide_latitud)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="dv">2</span>), <span class="at">shape =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> sedes_granada,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fu">rel</span>(<span class="dv">3</span>),</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"darkorange"</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Sin asignar"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="unnamed-chunk-13-1.png" width="672"></p>
</section>
<section id="optimización" class="level2">
<h2 class="anchored" data-anchor-id="optimización">Optimización</h2>
<p>Para optimizar el problema vamos a usar la librería <code>ompr</code> que permite plantear el problema de optimización lineal entera de forma sencilla, y se conecta a la librería <code>ROI</code> que es la que al final llama al solver. Como solver vamos a utilizar <code>glpk</code> que es software libre y lo suficientemente bueno para este ejemplo.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ompr)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ompr.roi)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ROI.plugin.glpk)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork) <span class="co"># pa unir los ggplots resultantes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Definimos el modelo</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>mip_model_granada <span class="ot">&lt;-</span> <span class="fu">MIPModel</span>() <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># variable indicadora que indica si una tienda i se asigna a comercial j</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_variable</span>(x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n, <span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>m, <span class="at">type =</span> <span class="st">"binary"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Minimizar el objetivo de distancia</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_objective</span>(<span class="fu">sum_over</span>(<span class="fu">transportcost_granada</span>(i, j) <span class="sc">*</span> x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n, <span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>m), <span class="st">"min"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cada tienda (código postal) solo debe ir a un comerciial. el comercial puede atender varios</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_constraint</span>(<span class="fu">sum_over</span>(x[i, j], <span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>m) <span class="sc">==</span> <span class="dv">1</span>, <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n) <span class="sc">%&gt;%</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># todo el mundo tiene que atender al minimo a una tienda</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_constraint</span>(<span class="fu">sum_over</span>(x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n) <span class="sc">&gt;=</span> <span class="dv">1</span>, <span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>m) <span class="sc">%&gt;%</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   Los jefes curran menos, como máximo 7 tiendas</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_constraint</span>(<span class="fu">sum_over</span>(x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n) <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>njefes) <span class="sc">%&gt;%</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Los indios al menos atienden a 3 tiendas</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_constraint</span>(<span class="fu">sum_over</span>(x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n) <span class="sc">&gt;=</span> <span class="dv">3</span>, <span class="at">j =</span> (njefes <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>m) <span class="sc">%&gt;%</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># para no sobrecargar mucho a los indios, les pongo un máximo que sea 1.5 veces el núemro de tiendas entre total currantes (jefes + indios)</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_constraint</span>(<span class="fu">sum_over</span>(x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n) <span class="sc">&lt;=</span> <span class="fu">round</span>(<span class="fl">1.5</span> <span class="sc">*</span> n <span class="sc">/</span> m), <span class="at">j =</span> (njefes <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>m) <span class="sc">%&gt;%</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_constraint</span>(<span class="fu">sum_over</span>(x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n) <span class="sc">&gt;=</span> <span class="fu">sum_over</span>(x[i, k], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n), <span class="at">j =</span> (njefes <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>m, <span class="at">k =</span> <span class="dv">1</span><span class="sc">:</span>njefes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Algunas aclaraciones de la sintaxis anterior.</p>
<ul>
<li><p>Nuestra variable auxilizar es <code>\(X_{i,j}\)</code> dónde la i son los códigos postales y la j cada empleado.</p></li>
<li><p>Se trata de minimizar la suma total de distancias cuando se asigna un código postal a un empleado, para todos los códigos postales y todos los empleados.</p></li>
<li><p>La restricción <code>add_constraint(sum_over(x[i, j], j = 1:m) == 1  , i = 1:n)</code> si nos fijamos en el sum_over significa sumar en j (empleados) para cada código postal (i) y que esa suma valga 1. Es decir, para cada código postal (i) sólo se permite que sea asignado a un empleado</p></li>
<li><p><code>add_constraint(sum_over(x[i, j], i = 1:n) &gt;= 1  , j = 1:m)</code> Que para cada empleado (j) la suma de todos los códigos postales que se le asignen sea mayor o igual que 1. Vamos que no se quede ninguno ocioso.</p></li>
<li><p><code>add_constraint(sum_over( x[i,j], i = 1:n)  &lt;= 7, j = 1:njefes)</code> por eso ordeanmos por tipo para que el índice 1:njefes corresponda a los empleados jefes, esta restricción asegura que a un jefe no se le asignen más de 7 códigos postales.</p></li>
<li><p><code>add_constraint(sum_over( x[i,j], i = 1:n)  &gt;=  3 , j = (njefes +1):m)</code> Mínimo 3 códigos postales para los indios.</p></li>
<li><p><code>add_constraint(sum_over( x[i,j], i = 1:n)  &lt;=  round(1.5 * n/m) , j = (njefes +1):m)</code> Esta restricción intenta equilibrar el número de asignaciones para los indios, de forma que como mucho a un empleado tenga 1.5 veces la media de códigos postales por empleado.</p></li>
<li><p><code>add_constraint(sum_over( x[i,j], i = 1:n)  &gt;=  sum_over( x[i,k], i = 1:n) , j = (njefes +1):m, k = 1:njefes)</code> En esta restricción es dónde aseguramos que ningún empleado tenga menos asignaciones que ningún jefe, por eso se ha usado el índice k.</p></li>
</ul>
<p>Pues el problema tiene 2200 variables (todas binarias) y 257 restricciones.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>mip_model_granada</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## Mixed integer linear optimization problem
## Variables:
##   Continuous: 0 
##   Integer: 0 
##   Binary: 2200 
## Model sense: minimize 
## Constraints: 257</code></pre>
<p>Resolvemos con glpk</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>result_granada <span class="ot">&lt;-</span> <span class="fu">solve_model</span>(mip_model_granada, <span class="fu">with_ROI</span>(<span class="at">solver =</span> <span class="st">"glpk"</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## &lt;SOLVER MSG&gt;  ----
## GLPK Simplex Optimizer, v4.65
## 257 rows, 2200 columns, 19200 non-zeros
##       0: obj =   0.000000000e+00 inf =   2.320e+02 (218)
##     397: obj =   9.427540716e+03 inf =   5.627e-13 (0) 1
## *   870: obj =   3.723682515e+03 inf =   0.000e+00 (0) 2
## OPTIMAL LP SOLUTION FOUND
## GLPK Integer Optimizer, v4.65
## 257 rows, 2200 columns, 19200 non-zeros
## 2200 integer variables, all of which are binary
## Integer optimization begins...
## Long-step dual simplex will be used
## +   870: mip =     not found yet &gt;=              -inf        (1; 0)
## +   870: &gt;&gt;&gt;&gt;&gt;   3.723682515e+03 &gt;=   3.723682515e+03   0.0% (1; 0)
## +   870: mip =   3.723682515e+03 &gt;=     tree is empty   0.0% (0; 1)
## INTEGER OPTIMAL SOLUTION FOUND
## &lt;!SOLVER MSG&gt; ----</code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>result_granada</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## Status: success
## Objective value: 3723.683</code></pre>
<p>Y ahora procedemos a ver las asignaciones. Para eso utilizamos la función <code>get_solution</code> que nos va a devolver la solución obtenida para nuestra variable <code>\(X_{i,j}\)</code></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>matching <span class="ot">&lt;-</span> result_granada <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_solution</span>(x[i, j]) <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(i, j, value) <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="co"># nons quedamos con las asignaciones</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>matching</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>##       i  j value
## 1    16  1     1
## 2    27  1     1
## 3    55  1     1
## 4    68  1     1
## 5   119  1     1
## 6   157  1     1
## 7   173  1     1
## 8    13  2     1
## 9    37  2     1
## 10   96  2     1
## 11  113  2     1
## 12  161  2     1
## 13  169  2     1
## 14  178  2     1
## 15  141  3     1
## 16   34  4     1
## 17    1  5     1
## 18    8  5     1
## 19   23  5     1
## 20   30  5     1
## 21   32  5     1
## 22   71  5     1
## 23   98  5     1
## 24  102  5     1
## 25  108  5     1
## 26  112  5     1
## 27  117  5     1
## 28  120  5     1
## 29  122  5     1
## 30  124  5     1
## 31  130  5     1
## 32  132  5     1
## 33  134  5     1
## 34  137  5     1
## 35  138  5     1
## 36  140  5     1
## 37  149  5     1
## 38  170  5     1
## 39  182  5     1
## 40  191  5     1
## 41  192  5     1
## 42  194  5     1
## 43  198  5     1
## 44   10  6     1
## 45   15  6     1
## 46   20  6     1
## 47   65  6     1
## 48   69  6     1
## 49   82  6     1
## 50   83  6     1
## 51   86  6     1
## 52   87  6     1
## 53   92  6     1
## 54   93  6     1
## 55  116  6     1
## 56  128  6     1
## 57  133  6     1
## 58  135  6     1
## 59  144  6     1
## 60  151  6     1
## 61  153  6     1
## 62  163  6     1
## 63  168  6     1
## 64  174  6     1
## 65  177  6     1
## 66  190  6     1
## 67  199  6     1
## 68    2  7     1
## 69    5  7     1
## 70    6  7     1
## 71    7  7     1
## 72   11  7     1
## 73   12  7     1
## 74   17  7     1
## 75   24  7     1
## 76   26  7     1
## 77   28  7     1
## 78   31  7     1
## 79   44  7     1
## 80   48  7     1
## 81   53  7     1
## 82   56  7     1
## 83   72  7     1
## 84   77  7     1
## 85   91  7     1
## 86  104  7     1
## 87  105  7     1
## 88  131  7     1
## 89  147  7     1
## 90  156  7     1
## 91  166  7     1
## 92  171  7     1
## 93  187  7     1
## 94  193  7     1
## 95   14  8     1
## 96   39  8     1
## 97   40  8     1
## 98   47  8     1
## 99   54  8     1
## 100  59  8     1
## 101  60  8     1
## 102  62  8     1
## 103  70  8     1
## 104  73  8     1
## 105  75  8     1
## 106  78  8     1
## 107  79  8     1
## 108  84  8     1
## 109  85  8     1
## 110  90  8     1
## 111  97  8     1
## 112  99  8     1
## 113 101  8     1
## 114 109  8     1
## 115 110  8     1
## 116 118  8     1
## 117 126  8     1
## 118 167  8     1
## 119 185  8     1
## 120 189  8     1
## 121 195  8     1
## 122   9  9     1
## 123  25  9     1
## 124  29  9     1
## 125  33  9     1
## 126  35  9     1
## 127  46  9     1
## 128  50  9     1
## 129  51  9     1
## 130  57  9     1
## 131  63  9     1
## 132  67  9     1
## 133  74  9     1
## 134  80  9     1
## 135  88  9     1
## 136 103  9     1
## 137 107  9     1
## 138 111  9     1
## 139 114  9     1
## 140 115  9     1
## 141 125  9     1
## 142 136  9     1
## 143 162  9     1
## 144 172  9     1
## 145 175  9     1
## 146 179  9     1
## 147 180  9     1
## 148 196  9     1
## 149   3 10     1
## 150   4 10     1
## 151  22 10     1
## 152  36 10     1
## 153  38 10     1
## 154  45 10     1
## 155  49 10     1
## 156  61 10     1
## 157  64 10     1
## 158  76 10     1
## 159  89 10     1
## 160 106 10     1
## 161 127 10     1
## 162 129 10     1
## 163 139 10     1
## 164 143 10     1
## 165 148 10     1
## 166 152 10     1
## 167 154 10     1
## 168 155 10     1
## 169 159 10     1
## 170 176 10     1
## 171 181 10     1
## 172 183 10     1
## 173 186 10     1
## 174  18 11     1
## 175  19 11     1
## 176  21 11     1
## 177  41 11     1
## 178  42 11     1
## 179  43 11     1
## 180  52 11     1
## 181  58 11     1
## 182  66 11     1
## 183  81 11     1
## 184  94 11     1
## 185  95 11     1
## 186 100 11     1
## 187 121 11     1
## 188 123 11     1
## 189 142 11     1
## 190 145 11     1
## 191 146 11     1
## 192 150 11     1
## 193 158 11     1
## 194 160 11     1
## 195 164 11     1
## 196 165 11     1
## 197 184 11     1
## 198 188 11     1
## 199 197 11     1
## 200 200 11     1</code></pre>
<p>Ahora vemos cuántas asignaciones tiene cada empleado y pintamos los resultados</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>asignaciones <span class="ot">&lt;-</span> matching <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(j) <span class="sc">%&gt;%</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">asignaciones =</span> <span class="fu">sum</span>(value)) <span class="sc">%&gt;%</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(asignaciones)) <span class="sc">%&gt;%</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(sedes_granada, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"j"</span> <span class="ot">=</span> <span class="st">"id_sede"</span>))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>asignaciones</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## # A tibble: 11 × 9
##        j asignaciones cod_postal tipo  cod_prov  area_m2 centr…¹ centr…² provi…³
##    &lt;int&gt;        &lt;dbl&gt; &lt;fct&gt;      &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;  
##  1     5           27 18197      indio 18         1.00e7   -3.61    37.2 GRANADA
##  2     7           27 18414      indio 18         4.04e7   -3.34    36.9 GRANADA
##  3     8           27 18197      indio 18         1.00e7   -3.61    37.2 GRANADA
##  4     9           27 18369      indio 18         1.77e7   -4.01    37.2 GRANADA
##  5    11           27 18514      indio 18         1.11e8   -3.08    37.2 GRANADA
##  6    10           25 18611      indio 18         3.35e7   -3.60    36.8 GRANADA
##  7     6           24 18516      indio 18         1.47e8   -3.24    37.2 GRANADA
##  8     1            7 18328      jefe  18         5.86e7   -3.87    37.2 GRANADA
##  9     2            7 18006      jefe  18         3.25e6   -3.61    37.2 GRANADA
## 10     3            1 18516      jefe  18         1.47e8   -3.24    37.2 GRANADA
## 11     4            1 18516      jefe  18         1.47e8   -3.24    37.2 GRANADA
## # … with abbreviated variable names ¹​centroide_longitud, ²​centroide_latitud,
## #   ³​provincia</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>plot_assignment <span class="ot">&lt;-</span> matching <span class="sc">%&gt;%</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(cod_postales_granada, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"i"</span> <span class="ot">=</span> <span class="st">"id"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(sedes_granada, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"j"</span> <span class="ot">=</span> <span class="st">"id_sede"</span>), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_clientes"</span>, <span class="st">"_comerciales"</span>))</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>p_jefes <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> plot_assignment <span class="sc">%&gt;%</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(tipo <span class="sc">==</span> <span class="st">"jefe"</span>),</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> centroide_longitud_comerciales,</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> centroide_latitud_comerciales,</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">xend =</span> centroide_longitud_clientes,</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">yend =</span> centroide_latitud_clientes</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">"Asignaciones para los jefes"</span>))</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>p_indios <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> plot_assignment <span class="sc">%&gt;%</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(tipo <span class="sc">==</span> <span class="st">"indio"</span>),</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> centroide_longitud_comerciales,</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> centroide_latitud_comerciales,</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">xend =</span> centroide_longitud_clientes,</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">yend =</span> centroide_latitud_clientes</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">"Asignaciones para los indios"</span>))</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>p_or <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"sin asignar"</span>,</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Granada"</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>p_final <span class="ot">&lt;-</span> p_or <span class="sc">/</span> p_jefes <span class="sc">/</span> p_indios</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>p_final</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="unnamed-chunk-21-1.png" width="384"></p>
</section>
<section id="io-al-servicio-del-mal-eligiendo-provincia" class="level2">
<h2 class="anchored" data-anchor-id="io-al-servicio-del-mal-eligiendo-provincia">IO al servicio del mal eligiendo provincia</h2>
<p>Creo función (francamente mejorable y modularizable) para poder elegir provincia o provincias</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>get_asignaciones_x_provincia <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">cod_postales =</span> cod_postales, <span class="at">sedes =</span> sedes,</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">provincia_sel =</span> <span class="st">"MADRID"</span>, <span class="at">plot =</span> <span class="cn">TRUE</span>, ...) {</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  cod_postales_filt <span class="ot">&lt;-</span> cod_postales <span class="sc">%&gt;%</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(provincia <span class="sc">%in%</span> provincia_sel) <span class="sc">%&gt;%</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>())</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  sedes_filt <span class="ot">&lt;-</span> sedes <span class="sc">%&gt;%</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(provincia <span class="sc">%in%</span> provincia_sel) <span class="sc">%&gt;%</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(tipo)) <span class="sc">%&gt;%</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id_sede =</span> <span class="fu">row_number</span>())</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">nrow</span>(sedes_filt)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(cod_postales_filt)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  n_sedes <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(sedes_filt<span class="sc">$</span>cod_postal))</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>  njefes <span class="ot">&lt;-</span> sedes_filt <span class="sc">%&gt;%</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(tipo <span class="sc">==</span> <span class="st">"jefe"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(n)</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>  n_indios <span class="ot">&lt;-</span> m <span class="sc">-</span> njefes</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>  transportcost <span class="ot">&lt;-</span> <span class="cf">function</span>(i, j) {</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>    cliente <span class="ot">&lt;-</span> cod_postales_filt[i, ]</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    comercial <span class="ot">&lt;-</span> sedes_filt[j, ]</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    distancia <span class="ot">&lt;-</span> geosphere<span class="sc">::</span><span class="fu">distHaversine</span>(</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(cliente<span class="sc">$</span>centroide_longitud, cliente<span class="sc">$</span>centroide_latitud),</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(comercial<span class="sc">$</span>centroide_longitud, comercial<span class="sc">$</span>centroide_latitud)</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (comercial[, <span class="st">"tipo"</span>] <span class="sc">==</span> <span class="st">"jefe"</span>) distancia <span class="ot">&lt;-</span> distancia <span class="sc">*</span> <span class="fl">1.1</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(distancia <span class="sc">/</span> <span class="dv">1000</span>)</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(cod_postales_filt, <span class="fu">aes</span>(centroide_longitud, centroide_latitud)) <span class="sc">+</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="dv">2</span>), <span class="at">shape =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> sedes_filt, <span class="at">size =</span> <span class="fu">rel</span>(<span class="dv">3</span>), <span class="at">color =</span> <span class="st">"darkorange"</span>) <span class="sc">+</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># scale_x_continuous(limits = c(0, grid_size+1)) +</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># scale_y_continuous(limits = c(0, grid_size+1)) +</span></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_blank</span>(), <span class="at">panel.grid =</span> <span class="fu">element_blank</span>()</span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>  mip_model <span class="ot">&lt;-</span> <span class="fu">MIPModel</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># variable indicadora que indica si una tienda i se asigna a comercial j</span></span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_variable</span>(x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n, <span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>m, <span class="at">type =</span> <span class="st">"binary"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Minimizar el objetivo de distancia</span></span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_objective</span>(<span class="fu">sum_over</span>(<span class="fu">transportcost</span>(i, j) <span class="sc">*</span> x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n, <span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>m), <span class="st">"min"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cada tienda (código postal) solo debe ir a un comerciial. el comercial puede atender varios</span></span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_constraint</span>(<span class="fu">sum_over</span>(x[i, j], <span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>m) <span class="sc">==</span> <span class="dv">1</span>, <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n) <span class="sc">%&gt;%</span></span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># todo el mundo tiene que atender al minimo a una tienda</span></span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_constraint</span>(<span class="fu">sum_over</span>(x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n) <span class="sc">&gt;=</span> <span class="dv">1</span>, <span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>m) <span class="sc">%&gt;%</span></span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># %&gt;%</span></span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   Los jefes curran menos, como máximo 7 tiendas</span></span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_constraint</span>(<span class="fu">sum_over</span>(x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n) <span class="sc">&lt;=</span> <span class="dv">7</span>, <span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>njefes) <span class="sc">%&gt;%</span></span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Los indios al menos atienden a 3 tiendas</span></span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_constraint</span>(<span class="fu">sum_over</span>(x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n) <span class="sc">&gt;=</span> <span class="dv">3</span>, <span class="at">j =</span> (njefes <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>m) <span class="sc">%&gt;%</span></span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># para no sobrecargar mucho a los indios, les pongo un máximo que sea 1.5 veces el núemro de tiendas entre total currantes (jefes + indios)</span></span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_constraint</span>(<span class="fu">sum_over</span>(x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n) <span class="sc">&lt;=</span> <span class="fu">round</span>(<span class="fl">1.5</span> <span class="sc">*</span> n <span class="sc">/</span> m), <span class="at">j =</span> (njefes <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>m) <span class="sc">%&gt;%</span></span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_constraint</span>(<span class="fu">sum_over</span>(x[i, j], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n) <span class="sc">&gt;=</span> <span class="fu">sum_over</span>(x[i, k], <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span>n), <span class="at">j =</span> (njefes <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>m, <span class="at">k =</span> <span class="dv">1</span><span class="sc">:</span>njefes)</span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a>  result2 <span class="ot">&lt;-</span> <span class="fu">solve_model</span>(mip_model, <span class="fu">with_ROI</span>(<span class="at">solver =</span> <span class="st">"glpk"</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>))</span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a>  matching <span class="ot">&lt;-</span> result2 <span class="sc">%&gt;%</span></span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_solution</span>(x[i, j]) <span class="sc">%&gt;%</span></span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(i, j, value) <span class="sc">%&gt;%</span></span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-77"><a href="#cb49-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-78"><a href="#cb49-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a>  asignaciones <span class="ot">&lt;-</span> matching <span class="sc">%&gt;%</span></span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(j) <span class="sc">%&gt;%</span></span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">asignaciones =</span> <span class="fu">sum</span>(value)) <span class="sc">%&gt;%</span></span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(asignaciones)) <span class="sc">%&gt;%</span></span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(sedes_filt, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"j"</span> <span class="ot">=</span> <span class="st">"id_sede"</span>))</span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-86"><a href="#cb49-86" aria-hidden="true" tabindex="-1"></a>  plot_assignment <span class="ot">&lt;-</span> matching <span class="sc">%&gt;%</span></span>
<span id="cb49-87"><a href="#cb49-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(cod_postales_filt, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"i"</span> <span class="ot">=</span> <span class="st">"id"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb49-88"><a href="#cb49-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(sedes_filt, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"j"</span> <span class="ot">=</span> <span class="st">"id_sede"</span>), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_clientes"</span>, <span class="st">"_comerciales"</span>))</span>
<span id="cb49-89"><a href="#cb49-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-90"><a href="#cb49-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-91"><a href="#cb49-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-92"><a href="#cb49-92" aria-hidden="true" tabindex="-1"></a>  p_jefes <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb49-93"><a href="#cb49-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(</span>
<span id="cb49-94"><a href="#cb49-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> plot_assignment <span class="sc">%&gt;%</span></span>
<span id="cb49-95"><a href="#cb49-95" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(tipo <span class="sc">==</span> <span class="st">"jefe"</span>),</span>
<span id="cb49-96"><a href="#cb49-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb49-97"><a href="#cb49-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> centroide_longitud_comerciales,</span>
<span id="cb49-98"><a href="#cb49-98" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> centroide_latitud_comerciales,</span>
<span id="cb49-99"><a href="#cb49-99" aria-hidden="true" tabindex="-1"></a>        <span class="at">xend =</span> centroide_longitud_clientes,</span>
<span id="cb49-100"><a href="#cb49-100" aria-hidden="true" tabindex="-1"></a>        <span class="at">yend =</span> centroide_latitud_clientes</span>
<span id="cb49-101"><a href="#cb49-101" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb49-102"><a href="#cb49-102" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb49-103"><a href="#cb49-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">"Asignaciones para los jefes"</span>))</span>
<span id="cb49-104"><a href="#cb49-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-105"><a href="#cb49-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-106"><a href="#cb49-106" aria-hidden="true" tabindex="-1"></a>  p_indios <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb49-107"><a href="#cb49-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(</span>
<span id="cb49-108"><a href="#cb49-108" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> plot_assignment <span class="sc">%&gt;%</span></span>
<span id="cb49-109"><a href="#cb49-109" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(tipo <span class="sc">==</span> <span class="st">"indio"</span>),</span>
<span id="cb49-110"><a href="#cb49-110" aria-hidden="true" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb49-111"><a href="#cb49-111" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> centroide_longitud_comerciales,</span>
<span id="cb49-112"><a href="#cb49-112" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> centroide_latitud_comerciales,</span>
<span id="cb49-113"><a href="#cb49-113" aria-hidden="true" tabindex="-1"></a>        <span class="at">xend =</span> centroide_longitud_clientes,</span>
<span id="cb49-114"><a href="#cb49-114" aria-hidden="true" tabindex="-1"></a>        <span class="at">yend =</span> centroide_latitud_clientes</span>
<span id="cb49-115"><a href="#cb49-115" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb49-116"><a href="#cb49-116" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb49-117"><a href="#cb49-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">"Asignaciones para los indios"</span>))</span>
<span id="cb49-118"><a href="#cb49-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-119"><a href="#cb49-119" aria-hidden="true" tabindex="-1"></a>  subtitulo <span class="ot">&lt;-</span> <span class="fu">reduce</span>(provincia_sel, <span class="cf">function</span>(x, y) <span class="fu">paste</span>(x, y, <span class="at">sep =</span> <span class="st">"-"</span>))</span>
<span id="cb49-120"><a href="#cb49-120" aria-hidden="true" tabindex="-1"></a>  p_or <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb49-121"><a href="#cb49-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb49-122"><a href="#cb49-122" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"sin asignar"</span>,</span>
<span id="cb49-123"><a href="#cb49-123" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> subtitulo</span>
<span id="cb49-124"><a href="#cb49-124" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-125"><a href="#cb49-125" aria-hidden="true" tabindex="-1"></a>  p_final <span class="ot">&lt;-</span> p_or <span class="sc">/</span> p_jefes <span class="sc">/</span> p_indios</span>
<span id="cb49-126"><a href="#cb49-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-127"><a href="#cb49-127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (plot) <span class="fu">print</span>(p_final)</span>
<span id="cb49-128"><a href="#cb49-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-129"><a href="#cb49-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb49-130"><a href="#cb49-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">comerciales =</span> sedes_filt,</span>
<span id="cb49-131"><a href="#cb49-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">cod_postales =</span> cod_postales_filt,</span>
<span id="cb49-132"><a href="#cb49-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">matching =</span> matching, <span class="at">tot_asignaciones =</span> asignaciones, <span class="at">plot_final =</span> p_final</span>
<span id="cb49-133"><a href="#cb49-133" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb49-134"><a href="#cb49-134" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Y veamos algunos ejemplos.</p>
<section id="madrid" class="level3">
<h3 class="anchored" data-anchor-id="madrid">MADRID</h3>
<div class="sourceCode" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>madrid <span class="ot">&lt;-</span> <span class="fu">get_asignaciones_x_provincia</span>(cod_postales, sedes, <span class="at">provincia_sel =</span> <span class="st">"MADRID"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## &lt;SOLVER MSG&gt;  ----
## GLPK Simplex Optimizer, v4.65
## 385 rows, 4425 columns, 45725 non-zeros
##       0: obj =   0.000000000e+00 inf =   3.400e+02 (320)
##     498: obj =   1.415569938e+04 inf =   5.690e-14 (0) 1
## Perturbing LP to avoid stalling [939]...
## Removing LP perturbation [1341]...
## *  1341: obj =   5.881701905e+03 inf =   0.000e+00 (0) 4
## OPTIMAL LP SOLUTION FOUND
## GLPK Integer Optimizer, v4.65
## 385 rows, 4425 columns, 45725 non-zeros
## 4425 integer variables, all of which are binary
## Integer optimization begins...
## Long-step dual simplex will be used
## +  1341: mip =     not found yet &gt;=              -inf        (1; 0)
## +  1341: &gt;&gt;&gt;&gt;&gt;   5.881701905e+03 &gt;=   5.881701905e+03   0.0% (1; 0)
## +  1341: mip =   5.881701905e+03 &gt;=     tree is empty   0.0% (0; 1)
## INTEGER OPTIMAL SOLUTION FOUND
## &lt;!SOLVER MSG&gt; ----</code></pre>
<p><img src="unnamed-chunk-23-1.png" width="384"></p>
<p>Podemos ver cuántos códigos postales le han tocado a cada empleado.</p>
<p>Se ve que se cumplen las restricciones. Seguramente para ser más equitativo habría que tocar algo a mano, para que a los empleados indios de la misma sede se repartan mejor los códigos postales. pero como primera aproximación no está mal</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>madrid<span class="sc">$</span>tot_asignaciones <span class="sc">%&gt;%</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cod_postal)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## # A tibble: 15 × 9
##        j asignaciones cod_postal tipo  cod_prov  area_m2 centr…¹ centr…² provi…³
##    &lt;int&gt;        &lt;dbl&gt; &lt;fct&gt;      &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;  
##  1     2            7 28011      jefe  28         3.03e7   -3.75    40.4 MADRID 
##  2     1            7 28015      jefe  28         2.59e6   -3.71    40.4 MADRID 
##  3     5            7 28015      jefe  28         2.59e6   -3.71    40.4 MADRID 
##  4    12           30 28035      indio 28         2.20e7   -3.74    40.5 MADRID 
##  5    14           30 28213      indio 28         8.52e7   -4.19    40.4 MADRID 
##  6     9           30 28521      indio 28         3.53e7   -3.50    40.3 MADRID 
##  7     7           30 28668      indio 28         3.65e6   -3.84    40.4 MADRID 
##  8    13           30 28755      indio 28         1.23e8   -3.60    41.1 MADRID 
##  9     6           25 28755      indio 28         1.23e8   -3.60    41.1 MADRID 
## 10     8           17 28755      indio 28         1.23e8   -3.60    41.1 MADRID 
## 11    11            8 28755      indio 28         1.23e8   -3.60    41.1 MADRID 
## 12     4            7 28817      jefe  28         6.04e7   -3.26    40.5 MADRID 
## 13    15           30 28901      indio 28         1.62e6   -3.73    40.3 MADRID 
## 14    10           30 28931      indio 28         8.78e5   -3.86    40.3 MADRID 
## 15     3            7 28931      jefe  28         8.78e5   -3.86    40.3 MADRID 
## # … with abbreviated variable names ¹​centroide_longitud, ²​centroide_latitud,
## #   ³​provincia</code></pre>
<p>Podemos ver el detalle, por ejemplo qué códigos postales le toca al empleado j=4</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>madrid_asignaciones <span class="ot">&lt;-</span>  madrid<span class="sc">$</span>tot_asignaciones  <span class="sc">%&gt;%</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(madrid<span class="sc">$</span>matching, <span class="at">by =</span> <span class="st">"j"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(madrid<span class="sc">$</span>cod_postales, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"i"</span> <span class="ot">=</span> <span class="st">"id"</span>), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">""</span>,<span class="st">"_tienda"</span>)) </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>madrid_asignaciones <span class="sc">%&gt;%</span> </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(j<span class="sc">==</span><span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(tipo ,j, i, cod_postal, cod_postal_tienda)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## # A tibble: 7 × 5
##   tipo      j     i cod_postal cod_postal_tienda
##   &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;fct&gt;      &lt;fct&gt;            
## 1 jefe      4    61 28817      28810            
## 2 jefe      4    71 28817      28812            
## 3 jefe      4    89 28817      28818            
## 4 jefe      4   121 28817      28515            
## 5 jefe      4   155 28817      28804            
## 6 jefe      4   172 28817      28817            
## 7 jefe      4   219 28817      28811</code></pre>
</section>
<section id="barcelona" class="level3">
<h3 class="anchored" data-anchor-id="barcelona">Barcelona</h3>
<div class="sourceCode" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>barcelona <span class="ot">&lt;-</span> <span class="fu">get_asignaciones_x_provincia</span>(cod_postales, sedes, <span class="at">provincia_sel =</span><span class="st">"BARCELONA"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## &lt;SOLVER MSG&gt;  ----
## GLPK Simplex Optimizer, v4.65
## 471 rows, 5715 columns, 59055 non-zeros
##       0: obj =   0.000000000e+00 inf =   4.260e+02 (406)
##     600: obj =   1.389502410e+04 inf =   9.258e-13 (0) 1
## Perturbing LP to avoid stalling [1077]...
## Removing LP perturbation [1716]...
## *  1716: obj =   7.841913058e+03 inf =   0.000e+00 (0) 5
## OPTIMAL LP SOLUTION FOUND
## GLPK Integer Optimizer, v4.65
## 471 rows, 5715 columns, 59055 non-zeros
## 5715 integer variables, all of which are binary
## Integer optimization begins...
## Long-step dual simplex will be used
## +  1716: mip =     not found yet &gt;=              -inf        (1; 0)
## +  1716: &gt;&gt;&gt;&gt;&gt;   7.841913058e+03 &gt;=   7.841913058e+03   0.0% (1; 0)
## +  1716: mip =   7.841913058e+03 &gt;=     tree is empty   0.0% (0; 1)
## INTEGER OPTIMAL SOLUTION FOUND
## &lt;!SOLVER MSG&gt; ----</code></pre>
<p><img src="unnamed-chunk-26-1.png" width="384"></p>
</section>
<section id="sevilla" class="level3">
<h3 class="anchored" data-anchor-id="sevilla">Sevilla</h3>
<div class="sourceCode" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>sevilla <span class="ot">&lt;-</span> <span class="fu">get_asignaciones_x_provincia</span>(cod_postales, sedes, <span class="at">provincia_sel =</span> <span class="st">"SEVILLA"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## &lt;SOLVER MSG&gt;  ----
## GLPK Simplex Optimizer, v4.65
## 182 rows, 1064 columns, 7448 non-zeros
##       0: obj =   0.000000000e+00 inf =   1.710e+02 (163)
##     243: obj =   8.653234667e+03 inf =   5.145e-13 (0)
## *   572: obj =   3.623165871e+03 inf =   0.000e+00 (0) 1
## OPTIMAL LP SOLUTION FOUND
## GLPK Integer Optimizer, v4.65
## 182 rows, 1064 columns, 7448 non-zeros
## 1064 integer variables, all of which are binary
## Integer optimization begins...
## Long-step dual simplex will be used
## +   572: mip =     not found yet &gt;=              -inf        (1; 0)
## +   572: &gt;&gt;&gt;&gt;&gt;   3.623165871e+03 &gt;=   3.623165871e+03   0.0% (1; 0)
## +   572: mip =   3.623165871e+03 &gt;=     tree is empty   0.0% (0; 1)
## INTEGER OPTIMAL SOLUTION FOUND
## &lt;!SOLVER MSG&gt; ----</code></pre>
<p><img src="unnamed-chunk-27-1.png" width="384"></p>
</section>
<section id="granada-y-málaga-juntas" class="level3">
<h3 class="anchored" data-anchor-id="granada-y-málaga-juntas">Granada y Málaga juntas</h3>
<div class="sourceCode" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>granada_malaga <span class="ot">&lt;-</span> <span class="fu">get_asignaciones_x_provincia</span>(cod_postales, sedes, <span class="at">provincia_sel =</span> <span class="fu">c</span>(<span class="st">"GRANADA"</span>,<span class="st">"MALAGA"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## &lt;SOLVER MSG&gt;  ----
## GLPK Simplex Optimizer, v4.65
## 488 rows, 7160 columns, 80550 non-zeros
##       0: obj =   0.000000000e+00 inf =   4.230e+02 (393)
##     515: obj =   2.754380624e+04 inf =   4.807e-13 (0) 1
## Perturbing LP to avoid stalling [1388]...
## Removing LP perturbation [1688]...
## *  1688: obj =   7.728634950e+03 inf =   0.000e+00 (0) 5
## OPTIMAL LP SOLUTION FOUND
## GLPK Integer Optimizer, v4.65
## 488 rows, 7160 columns, 80550 non-zeros
## 7160 integer variables, all of which are binary
## Integer optimization begins...
## Long-step dual simplex will be used
## +  1688: mip =     not found yet &gt;=              -inf        (1; 0)
## +  1688: &gt;&gt;&gt;&gt;&gt;   7.728634950e+03 &gt;=   7.728634950e+03   0.0% (1; 0)
## +  1688: mip =   7.728634950e+03 &gt;=     tree is empty   0.0% (0; 1)
## INTEGER OPTIMAL SOLUTION FOUND
## &lt;!SOLVER MSG&gt; ----</code></pre>
<p><img src="unnamed-chunk-28-1.png" width="384"></p>
<p>Y hasta aquí ha llegado el uso de la IO para el mal. Feliz verano !!</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="joscani/blogComments" data-repo-id="R_kgDOIXA9wA" data-category="General" data-category-id="DIC_kwDOIXA9wM4CSZhs" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>