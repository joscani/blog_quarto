{
  "hash": "c7f200081fbf6bf5f5500dc3724a9e28",
  "result": {
    "markdown": "---\ntitle: Api y docker con R. parte 1\nauthor: ''\ndate: '2022-10-12'\nslug: api-y-docker-con-r-parte-1\ncategories:\n  - docker\n  - R\n  - 2022\ndescription: ''\nexecute: \n  message: false\n  warning: false\n  echo: true\nformat: \n  html: \n    fig-height: 5\n    fig-dpi: 300\n    fig-width: 8.88\n    fig-align: center\nknitr:\n  opts_chunk:\n    out.width: 80%\n    fig.showtext: TRUE\n    collapse: true\n    comment: \"#>\"\n\n---\n\n\n\nTodo el mundo anda haciendo apis para poner modelos en producción, y oye, está bien. Si además lo complementas con dockerizarlo para tener un entorno controlado y que te valga para ponerlo en cualquier sitio dónde esté docker instalado pues mejor. \n\nAquí voy a contar un ejemplo de como se puede hacer con R usando `plumber` y docker, en siguentes post contaré como hacerlo con `vetiver` que es una librería que está para R y Python que tiene algún extra, como versionado de modelos y demás. \n\n\nLo primero de todo es trabajar en un proyecto nuevo y usar [`renv`](https://rstudio.github.io/renv/articles/renv.html). renv es para gestionar _entornos_ de R, ojo que también funciona bien si tienes que mezclar R y python.  Tiene cosas interesantes como descubrir las librerías que usas en tu proyecto y aún mejor, si estas librerías ya las tienes instaladas pues te crea enlaces simbólicos a dónde están y te permite ahorrar un montón de espacio, que al menos yo, no he conseguido ver cómo hacer eso con `conda`. \n\n\n## Objetivo\n\nMi objetivo es ver cómo pondría un modelo bayesiano ajustado  con [`brms`](https://github.com/paul-buerkner/brms) para que me devuelva predicciones puntuales y las posterioris en un entorno de producción. \n\n\n## Entrenando modelo\n\nPara eso voy a usar datos de un [antiguo post](https://muestrear-no-es-pecado.netlify.app/2021/06/04/big-data-para-pobres-iii-bayesiano/). \n\nUna vez que estemos en ese nuevo proyecto, ajustamos y guardamos un modelo . \n\n\n\n\n```r\nlibrary(tidyverse)\n```\n\n```\n## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──\n## ✔ ggplot2 3.3.6      ✔ purrr   0.3.5 \n## ✔ tibble  3.1.8      ✔ dplyr   1.0.10\n## ✔ tidyr   1.2.1      ✔ stringr 1.4.1 \n## ✔ readr   2.1.3      ✔ forcats 0.5.2 \n## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n## ✖ dplyr::filter() masks stats::filter()\n## ✖ dplyr::lag()    masks stats::lag()\n```\n\n```r\nlibrary(brms)\n```\n\n```\n## Loading required package: Rcpp\n## Loading 'brms' package (version 2.18.0). Useful instructions\n## can be found by typing help('brms'). A more detailed introduction\n## to the package is available through vignette('brms_overview').\n## \n## Attaching package: 'brms'\n## \n## The following object is masked from 'package:stats':\n## \n##     ar\n```\n\n```r\nlibrary(cmdstanr)\n```\n\n```\n## Warning: package 'cmdstanr' was built under R version 4.3.0\n```\n\n```\n## This is cmdstanr version 0.5.2\n## - CmdStanR documentation and vignettes: mc-stan.org/cmdstanr\n## - Use set_cmdstan_path() to set the path to CmdStan\n## - Use install_cmdstan() to install CmdStan\n```\n\n```r\n## Using all cores. 12 in my machine, y que haga las cadenas en paralelo\noptions(mc.cores = parallel::detectCores())\nset_cmdstan_path(\"~/cmdstan/\")\n```\n\n```\n## CmdStan path set to: /home/jose/cmdstan\n```\n\n```r\ntrain <- read_csv(here::here(\"data/train_local.csv\"))\n```\n\n```\n## Rows: 662 Columns: 5\n## ── Column specification ────────────────────────────────────────────────────────\n## Delimiter: \",\"\n## chr (3): segmento, tipo, edad_cat\n## dbl (2): valor_cliente, n\n## \n## ℹ Use `spec()` to retrieve the full column specification for this data.\n## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n```r\n# guiña a librería antigua\ncar::some(train)\n```\n\n```\n## # A tibble: 10 × 5\n##    segmento tipo  valor_cliente edad_cat     n\n##    <chr>    <chr>         <dbl> <chr>    <dbl>\n##  1 Rec      SM                2 21- 40       4\n##  2 Best     SM                1 41-50      475\n##  3 Best     C                 4 >60       2807\n##  4 No_way   C                 1 41-50      356\n##  5 No_way   B                 5 40-60      221\n##  6 Rec      SF                2 >60        152\n##  7 Rec      B                 4 40-60      194\n##  8 Best     C                 5 41-50     4934\n##  9 No_way   B                 3 41-50     1064\n## 10 No_way   SF                8 41-50       29\n```\n\nAjustamos un modelo bayesiano con efectos aleatorios y usando la columna `n` como pesos de las filas. (leer el post dónde usé estos datos para saber más)\n\n\n```r\ntrain <- train %>% \n    mutate(target1 = as_factor(ifelse(segmento == \"Best\", \"Best\", \"Other\")))\n\n\nformula <- brmsformula(\n    target1| resp_weights(n)  ~ (1 | edad_cat) + (1 | valor_cliente) + (1 | tipo)\n    )\n\nmod <- brm(\n    formula,\n     family = \"bernoulli\", data = train, \n    iter = 4000, warmup = 1000, cores = 4, chains = 4,\n    seed = 10,\n    backend = \"cmdstanr\", \n     refresh = 0) # refresh 0 qu eno quiero que se me llene el post de los output de las cadenas mcm\n\nsaveRDS(mod, here::here(\"brms_model.rds\"))\n```\n\n\n\n## Comprobamos que nuestro modelo funciona \n\n\n\n\n\n```r\nlibrary(tidybayes)\n```\n\n```\n## \n## Attaching package: 'tidybayes'\n```\n\n```\n## The following objects are masked from 'package:brms':\n## \n##     dstudent_t, pstudent_t, qstudent_t, rstudent_t\n```\n\n```r\nmod_reload <- readRDS(here::here(\"brms_model.rds\"))\n \n# \n\ntest <-  read_csv(here::here(\"data/test_local.csv\"))\n```\n\n```\n## Rows: 656 Columns: 5\n```\n\n```\n## ── Column specification ────────────────────────────────────────────────────────\n## Delimiter: \",\"\n## chr (3): segmento, tipo, edad_cat\n## dbl (2): valor_cliente, n\n## \n## ℹ Use `spec()` to retrieve the full column specification for this data.\n## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n```r\n# estimacion puntual\npredict(mod_reload, head(test))\n```\n\n```\n##        Estimate Est.Error Q2.5 Q97.5\n## [1,] 0.23216667 0.4222324    0     1\n## [2,] 0.13233333 0.3388669    0     1\n## [3,] 0.16075000 0.3673155    0     1\n## [4,] 0.13825000 0.3451766    0     1\n## [5,] 0.12716667 0.3331735    0     1\n## [6,] 0.07333333 0.2606937    0     1\n```\n\n```r\n# full posterior\n# para 6 filas guarda los valores obtenidos en las 3000 iteraciones de cada cadena\n# 3000 * 4 * 6 = 72000 valores \n\nposterior_pred <- add_epred_draws(head(test), mod_reload) \n\nhead(posterior_pred )\n```\n\n```\n## # A tibble: 6 × 10\n## # Groups:   segmento, tipo, valor_cliente, edad_cat, n, .row [1]\n##   segmento tipo  valor_cliente edad_cat     n  .row .chain .itera…¹ .draw .epred\n##   <chr>    <chr>         <dbl> <chr>    <dbl> <int>  <int>    <int> <int>  <dbl>\n## 1 Rec      C                 0 21- 40     132     1     NA       NA     1  0.230\n## 2 Rec      C                 0 21- 40     132     1     NA       NA     2  0.234\n## 3 Rec      C                 0 21- 40     132     1     NA       NA     3  0.233\n## 4 Rec      C                 0 21- 40     132     1     NA       NA     4  0.230\n## 5 Rec      C                 0 21- 40     132     1     NA       NA     5  0.232\n## 6 Rec      C                 0 21- 40     132     1     NA       NA     6  0.226\n## # … with abbreviated variable name ¹​.iteration\n```\n\n```r\ndim(posterior_pred)\n```\n\n```\n## [1] 72000    10\n```\n\nPara la primer fila podemos tener la distribución a posteriori \n\n\n\n```r\nposterior_pred %>% \n  filter(.row == 1) %>% \n  ggplot(aes(x=.epred)) +\n  geom_density() \n```\n\n<img src=\"unnamed-chunk-4-1.png\" width=\"672\" />\n\n\n\nPues listo, ya tenemos el modelo entrenado y guardado, ahora sólo queda escribir el código para la api y el Dockerfile..\n\n## Creando el plumber.R\n\nUna cosa importante, si hemos usado `renv` es escribir el fichero con las dependencias que usamos.  Eso se hace con `renv::snapshot()`  y se crea un fichero dónde están descritas las dependencias  versionadas de nuestro proyecto. \n\nPero quizá para el docker no necesitemos todas, en este caso, partiendo del fichero anterior nos creamos otro con sólo las dependencias necesarias.  Yo lo he llamado `vetiver_renv.lock` porque empecé trasteando con vetiver y soy demasiado vago como para cambiar ahora el nombre.  El contenido del fichero es \n\n`vetiver_renv.lock`\n\n```\n{\n  \"R\": {\n    \"Version\": \"4.2.1\",\n    \"Repositories\": [\n      {\n        \"Name\": \"binarios\",\n        \"URL\": \"https://packagemanager.rstudio.com/all/latest\"\n      },\n      {\n        \"Name\": \"ropenspain\",\n        \"URL\": \"https://ropenspain.r-universe.dev\"\n      }\n    ]\n  },\n  \"Packages\": {\n    \"plumber\": {\n      \"Package\": \"plumber\",\n      \"Version\": \"1.2.1\",\n      \"Source\": \"Repository\",\n      \"Repository\": \"RSPM\",\n      \"Hash\": \"8b65a7a00ef8edc5ddc6fabf0aff1194\",\n      \"Requirements\": [\n        \"R6\",\n        \"crayon\",\n        \"ellipsis\",\n        \"httpuv\",\n        \"jsonlite\",\n        \"lifecycle\",\n        \"magrittr\",\n        \"mime\",\n        \"promises\",\n        \"rlang\",\n        \"sodium\",\n        \"stringi\",\n        \"swagger\",\n        \"webutils\"\n      ]\n    },\n    \"brms\": {\n      \"Package\": \"brms\",\n      \"Version\": \"2.18.0\",\n      \"Source\": \"Repository\",\n      \"Repository\": \"RSPM\",\n      \"Hash\": \"afcb0d871e1759b68b29eb6affd37a10\",\n      \"Requirements\": [\n        \"Matrix\",\n        \"Rcpp\",\n        \"abind\",\n        \"backports\",\n        \"bayesplot\",\n        \"bridgesampling\",\n        \"coda\",\n        \"future\",\n        \"ggplot2\",\n        \"glue\",\n        \"loo\",\n        \"matrixStats\",\n        \"mgcv\",\n        \"nleqslv\",\n        \"nlme\",\n        \"posterior\",\n        \"rstan\",\n        \"rstantools\",\n        \"shinystan\"\n      ]\n    },\n    \"tidybayes\": {\n      \"Package\": \"tidybayes\",\n      \"Version\": \"3.0.2\",\n      \"Source\": \"Repository\",\n      \"Repository\": \"RSPM\",\n      \"Hash\": \"d501501261b724f35ec9f2b80f4421b5\",\n      \"Requirements\": [\n        \"arrayhelpers\",\n        \"coda\",\n        \"dplyr\",\n        \"ggdist\",\n        \"ggplot2\",\n        \"magrittr\",\n        \"posterior\",\n        \"rlang\",\n        \"tibble\",\n        \"tidyr\",\n        \"tidyselect\",\n        \"vctrs\",\n        \"withr\"\n      ]\n    }\n  }\n}\n\n```\n\nCómo veis también he añadido la librería tidybayes, porque me va a resultar útil para sacar la posteriori de las predicciones de los nuevos datos. \n\nCreamos el fichero `plumber.R` que no es más que decir cómo se va a predecir y crear un par de endpoints que permiten tanto obtener estimaciones puntuales como la full posterior. \n Con la librería `plumber` se hace fácil sin más que usar decoradores.\n \n Fichero `plumber.R` \n \n \n\n```r\nlibrary(brms)\nlibrary(plumber)\nlibrary(tidybayes)\n\nbrms_model <- readRDS(\"brms_model.rds\")\n\n\n#* @apiTitle brms predict Api\n#* @apiDescription Endpoints for working with brms model\n\n## ---- filter-logger\n#* Log some information about the incoming request\n#* @filter logger\nfunction(req){\n    cat(as.character(Sys.time()), \"-\",\n        req$REQUEST_METHOD, req$PATH_INFO, \"-\",\n        req$HTTP_USER_AGENT, \"@\", req$REMOTE_ADDR, \"\\n\")\n    forward()\n}\n\n## ---- post-data\n#* Submit data and get a prediction in return\n#* @post /predict\nfunction(req, res) {\n    data <- tryCatch(jsonlite::parse_json(req$postBody, simplifyVector = TRUE),\n                     error = function(e) NULL)\n    if (is.null(data)) {\n        res$status <- 400\n        return(list(error = \"No data submitted\"))\n    }\n    \n    predict(brms_model, data) |>\n        as.data.frame()\n}\n\n\n#* @post /full_posterior\nfunction(req, res) {\n    data <- tryCatch(jsonlite::parse_json(req$postBody, simplifyVector = TRUE),\n                     error = function(e) NULL)\n    if (is.null(data)) {\n        res$status <- 400\n        return(list(error = \"No data submitted\"))\n    }\n    \n    add_epred_draws(data, brms_model) \n        \n}\n```\n\nNo tiene mucho misterio, los endpoint se crean usando \n\n```\n#* @post  /nombre_endpoing\n```\n\ny creando una función que va a tomar los datos que le pasemos en formato json a la api, los pasa a data.frame y usa el modelo previamente cargado para obtener las estimaciones puntuales en un caso y la full posterior (con `add_epred_draws`) en el otro. \n\n\n\n\n\n\n\n## Creamos el docker \n\nIba a contar lo que es docker, pero mejor lo miráis en su [web](https://www.docker.com/). Sólo quedarnos con la idea que es como tener una máquina virtual que puedo usar en otro sitio, pero es mucho más ligera y puede usar cosas del sistema anfitrión e interactuar con él.   \n\nPara crear nuestra _imagen_ docker tenemos que crear un fichero que se llame `Dockerfile` dónde vamos a ir diciéndole como cree nuestra máquina virtual.\n\nEs importante que estén los ficheros anteriores, el modelo salvado , el plumber.R y el fichero .lock en las rutas correctas dónde los busca el Dockerfile, en mi caso, lo he puesto todo en el mismo sitio. \n\n\nContendido del Dockerfile\n\n```\n# Docker file para modelo brms\n\nFROM rocker/r-ver:4.2.1\nENV RENV_CONFIG_REPOS_OVERRIDE https://packagemanager.rstudio.com/cran/latest\n\nRUN apt-get update -qq && apt-get install -y --no-install-recommends \\\n  default-jdk \\\n  libcurl4-openssl-dev \\\n  libicu-dev \\\n  libsodium-dev \\\n  libssl-dev \\\n  make \\\n  zlib1g-dev \\\n  libxml2-dev \\\n  libglpk-dev \\\n  && apt-get clean\n\n\nCOPY vetiver_renv.lock renv.lock\nRUN Rscript -e \"install.packages('renv')\"\nRUN Rscript -e \"renv::restore()\"\n\n## Copio el modelo y el fichero de la api\nCOPY brms_model.rds /opt/ml/brms_model.rds\nCOPY plumber.R /opt/ml/plumber.R\n\nEXPOSE 8081\nENTRYPOINT [\"R\", \"-e\", \"pr <- plumber::plumb('/opt/ml/plumber.R'); pr$run(host = '0.0.0.0', port = 8081)\"]\n\n\n```\n\nImportante que el puerto que se exponga con `EXPOSE` sea el mismo que usa el plumber, en este caso el 8081. \n\n\nAhora para construir la imagen docker y ejecutarla\n\n\n```\ndocker build -t mi_modelo_brms .\n\n```\n\nY despues de un rato podemos ejecutarlo mapeando el puerto \n\n```\nnohup docker container run --rm -p 8081:8081 mi_modelo_brms & \n```\n\n\n## ¿Funciona?\n\nPodemos usar curl, python, php o cualquier otra cosa para mandar peticiones a la api y que nos devuelva predicciones, con R sería algo así. \n\n\n\n```r\ntest %>% \n    head(2) \n```\n\n```\n## # A tibble: 2 × 5\n##   segmento tipo  valor_cliente edad_cat     n\n##   <chr>    <chr>         <dbl> <chr>    <dbl>\n## 1 Rec      C                 0 21- 40     132\n## 2 Best     B                 0 41-50       19\n```\n\n```r\nbase_url <- \"http://0.0.0.0:8081\"\n\napi_res <- httr::POST(url = paste0(base_url, \"/predict\"),\n                      body = head(test),\n                      encode = \"json\")\npredicted_values <- httr::content(api_res, as = \"text\", encoding = \"UTF-8\")\n\njsonlite::fromJSON(predicted_values)\n```\n\n```\n##   Estimate Est.Error Q2.5 Q97.5\n## 1   0.2283    0.4198    0     1\n## 2   0.1356    0.3424    0     1\n## 3   0.1604    0.3670    0     1\n## 4   0.1320    0.3385    0     1\n## 5   0.1215    0.3267    0     1\n## 6   0.0737    0.2612    0     1\n```\n\n\n\n```r\napi_res2 <- httr::POST(url = paste0(base_url, \"/full_posterior\"),\n                      body = head(test,1),\n                      encode = \"json\")\nposterior_values <- httr::content(api_res2, as = \"text\", encoding = \"UTF-8\")\n\n\njsonlite::fromJSON(posterior_values)  %>% \n  head(100)\n```\n\n```\n##     segmento tipo valor_cliente edad_cat   n .row .draw .epred\n## 1        Rec    C             0   21- 40 132    1     1 0.2297\n## 2        Rec    C             0   21- 40 132    1     2 0.2341\n## 3        Rec    C             0   21- 40 132    1     3 0.2330\n## 4        Rec    C             0   21- 40 132    1     4 0.2296\n## 5        Rec    C             0   21- 40 132    1     5 0.2321\n## 6        Rec    C             0   21- 40 132    1     6 0.2256\n## 7        Rec    C             0   21- 40 132    1     7 0.2211\n## 8        Rec    C             0   21- 40 132    1     8 0.2215\n## 9        Rec    C             0   21- 40 132    1     9 0.2259\n## 10       Rec    C             0   21- 40 132    1    10 0.2245\n## 11       Rec    C             0   21- 40 132    1    11 0.2330\n## 12       Rec    C             0   21- 40 132    1    12 0.2263\n## 13       Rec    C             0   21- 40 132    1    13 0.2262\n## 14       Rec    C             0   21- 40 132    1    14 0.2426\n## 15       Rec    C             0   21- 40 132    1    15 0.2307\n## 16       Rec    C             0   21- 40 132    1    16 0.2348\n## 17       Rec    C             0   21- 40 132    1    17 0.2293\n## 18       Rec    C             0   21- 40 132    1    18 0.2281\n## 19       Rec    C             0   21- 40 132    1    19 0.2304\n## 20       Rec    C             0   21- 40 132    1    20 0.2277\n## 21       Rec    C             0   21- 40 132    1    21 0.2283\n## 22       Rec    C             0   21- 40 132    1    22 0.2355\n## 23       Rec    C             0   21- 40 132    1    23 0.2297\n## 24       Rec    C             0   21- 40 132    1    24 0.2257\n## 25       Rec    C             0   21- 40 132    1    25 0.2191\n## 26       Rec    C             0   21- 40 132    1    26 0.2275\n## 27       Rec    C             0   21- 40 132    1    27 0.2328\n## 28       Rec    C             0   21- 40 132    1    28 0.2312\n## 29       Rec    C             0   21- 40 132    1    29 0.2190\n## 30       Rec    C             0   21- 40 132    1    30 0.2370\n## 31       Rec    C             0   21- 40 132    1    31 0.2303\n## 32       Rec    C             0   21- 40 132    1    32 0.2252\n## 33       Rec    C             0   21- 40 132    1    33 0.2190\n## 34       Rec    C             0   21- 40 132    1    34 0.2269\n## 35       Rec    C             0   21- 40 132    1    35 0.2311\n## 36       Rec    C             0   21- 40 132    1    36 0.2309\n## 37       Rec    C             0   21- 40 132    1    37 0.2313\n## 38       Rec    C             0   21- 40 132    1    38 0.2361\n## 39       Rec    C             0   21- 40 132    1    39 0.2335\n## 40       Rec    C             0   21- 40 132    1    40 0.2414\n## 41       Rec    C             0   21- 40 132    1    41 0.2333\n## 42       Rec    C             0   21- 40 132    1    42 0.2283\n## 43       Rec    C             0   21- 40 132    1    43 0.2354\n## 44       Rec    C             0   21- 40 132    1    44 0.2314\n## 45       Rec    C             0   21- 40 132    1    45 0.2357\n## 46       Rec    C             0   21- 40 132    1    46 0.2240\n## 47       Rec    C             0   21- 40 132    1    47 0.2241\n## 48       Rec    C             0   21- 40 132    1    48 0.2355\n## 49       Rec    C             0   21- 40 132    1    49 0.2260\n## 50       Rec    C             0   21- 40 132    1    50 0.2268\n## 51       Rec    C             0   21- 40 132    1    51 0.2278\n## 52       Rec    C             0   21- 40 132    1    52 0.2213\n## 53       Rec    C             0   21- 40 132    1    53 0.2246\n## 54       Rec    C             0   21- 40 132    1    54 0.2316\n## 55       Rec    C             0   21- 40 132    1    55 0.2313\n## 56       Rec    C             0   21- 40 132    1    56 0.2209\n## 57       Rec    C             0   21- 40 132    1    57 0.2269\n## 58       Rec    C             0   21- 40 132    1    58 0.2323\n## 59       Rec    C             0   21- 40 132    1    59 0.2280\n## 60       Rec    C             0   21- 40 132    1    60 0.2357\n## 61       Rec    C             0   21- 40 132    1    61 0.2275\n## 62       Rec    C             0   21- 40 132    1    62 0.2387\n## 63       Rec    C             0   21- 40 132    1    63 0.2387\n## 64       Rec    C             0   21- 40 132    1    64 0.2231\n## 65       Rec    C             0   21- 40 132    1    65 0.2370\n## 66       Rec    C             0   21- 40 132    1    66 0.2313\n## 67       Rec    C             0   21- 40 132    1    67 0.2243\n## 68       Rec    C             0   21- 40 132    1    68 0.2335\n## 69       Rec    C             0   21- 40 132    1    69 0.2275\n## 70       Rec    C             0   21- 40 132    1    70 0.2340\n## 71       Rec    C             0   21- 40 132    1    71 0.2250\n## 72       Rec    C             0   21- 40 132    1    72 0.2373\n## 73       Rec    C             0   21- 40 132    1    73 0.2259\n## 74       Rec    C             0   21- 40 132    1    74 0.2405\n## 75       Rec    C             0   21- 40 132    1    75 0.2227\n## 76       Rec    C             0   21- 40 132    1    76 0.2210\n## 77       Rec    C             0   21- 40 132    1    77 0.2337\n## 78       Rec    C             0   21- 40 132    1    78 0.2306\n## 79       Rec    C             0   21- 40 132    1    79 0.2242\n## 80       Rec    C             0   21- 40 132    1    80 0.2235\n## 81       Rec    C             0   21- 40 132    1    81 0.2247\n## 82       Rec    C             0   21- 40 132    1    82 0.2188\n## 83       Rec    C             0   21- 40 132    1    83 0.2129\n## 84       Rec    C             0   21- 40 132    1    84 0.2415\n## 85       Rec    C             0   21- 40 132    1    85 0.2293\n## 86       Rec    C             0   21- 40 132    1    86 0.2312\n## 87       Rec    C             0   21- 40 132    1    87 0.2189\n## 88       Rec    C             0   21- 40 132    1    88 0.2236\n## 89       Rec    C             0   21- 40 132    1    89 0.2262\n## 90       Rec    C             0   21- 40 132    1    90 0.2317\n## 91       Rec    C             0   21- 40 132    1    91 0.2316\n## 92       Rec    C             0   21- 40 132    1    92 0.2288\n## 93       Rec    C             0   21- 40 132    1    93 0.2299\n## 94       Rec    C             0   21- 40 132    1    94 0.2288\n## 95       Rec    C             0   21- 40 132    1    95 0.2311\n## 96       Rec    C             0   21- 40 132    1    96 0.2264\n## 97       Rec    C             0   21- 40 132    1    97 0.2269\n## 98       Rec    C             0   21- 40 132    1    98 0.2287\n## 99       Rec    C             0   21- 40 132    1    99 0.2283\n## 100      Rec    C             0   21- 40 132    1   100 0.2191\n```\n\nSeguramente usar una api para  obtener la posteriori que tiene tantos valores para cada dato no sea lo más eficiente, porque lo devuelve en formato json y luego hay que convertirlo a data.frame, pero funciona. \n\n\n## Salvar docker en un tar.gz\n\nSi no tenemos un sitio estilo docker hub dónde registrar nuestros docker o por cualquier otra causa, podemos usar `docker save` para generar un fichero comprimido y `docker load` para importarlo. \n\nSería algo así como \n\n\n```bash \n\ndocker save mi_modelo_brms | gzip > mi_modelo_brms_docker.tar.gz\n\n``` \n\nCopiar ese tar.gz a dónde toque\n\n```bash\ndocker load < mi_modelo_brms_docker.tar.gz\n```\n\n\n\n\n## Adelanto con vetiver\n\nCon la librería vetiver se simplifica todo este proceso, puesto que crea por ti el plumber.R y el dockerfile y tiene movidas para guardar la monitorización del modelo y demás.  Está tanto para R como para python. En R soporta los modelos que estén en `tidymodels` y en python soporta `scikit-learn`, `statmodels`, `xgboost` y creo que también `pytorch` \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}